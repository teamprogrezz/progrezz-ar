ARProgrezz={},ARProgrezz.Utils={},function(e){e.Flags={SUCCESS:1,ERROR:-1,WAIT:0},"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180});var t=200;e.waitCallback=function(o,i){i&&(o.flag==ARProgrezz.Utils.Flags.WAIT?setTimeout(e.waitCallback,t,o,i):o.flag==ARProgrezz.Utils.Flags.SUCCESS&&i())},e.debugText=function(e){var t=document.querySelector("p");t?t.removeChild(t.childNodes[0]):(t=document.createElement("p"),document.body.appendChild(t));var o=document.createTextNode(e);t.appendChild(o)},e.rootDirectory=function(){for(var e=document.getElementsByTagName("script"),t=null,o=0;o<e.length;o++)if(""!==e[o].src&&(t=e[o].src),-1!=e[o].src.search("ARProgrezz.js")){t=e[o].src;break}var i=t.split("/").pop();return t.replace("/js/"+i,"")},e.fullScreen=function(){var e=document.documentElement,t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullScreen;t&&t.call(e)},e.lockOrientation=function(){screen.lockOrientation=screen.lockOrientation||screen.webkitLockOrientation||screen.mozLockOrientation||screen.msLockOrientation,screen.lockOrientation&&screen.lockOrientation("landscape")}}(ARProgrezz.Utils),ARProgrezz.Video=function(){function e(){t.arVideo=document.createElement("video"),t.arVideo.setAttribute("style","position: absolute;left: 0px;top: 0px;z-index: -1;background-size: cover;"),t.arVideo.width=window.innerWidth,t.arVideo.height=window.innerHeight,t.arVideo.autoplay=!0,t.arVideo.onloadedmetadata=function(){o.flag=ARProgrezz.Utils.Flags.SUCCESS},document.body.appendChild(t.arVideo),t.arVideo.src=window.URL.createObjectURL(ARProgrezz.Support.videoStream)}var t=this;this.arVideo=null,this.arVideoStereo=null,this.onSuccess=null;var o=null;this.updateSize=function(){t.arVideo instanceof ARProgrezz.Video.Panorama?t.arVideo.updateSize():(t.arVideo.height=window.innerHeight,t.arVideoStereo?(t.arVideo.width=window.innerWidth/2,t.arVideoStereo.width=window.innerWidth/2,t.arVideoStereo.height=window.innerHeight):t.arVideo.width=window.innerWidth)},this.removeVideo=function(){t.arVideo instanceof ARProgrezz.Video.Panorama?t.arVideo.destroy():(t.arVideoStereo&&t.disarmStereoscopicVideo(),document.body.removeChild(t.arVideo))},this.disarmStereoscopicVideo=function(){t.arVideo instanceof ARProgrezz.Video.Panorama||(t.arVideo.width=window.innerWidth,document.body.removeChild(t.arVideoStereo),t.arVideoStereo=null)},this.activateStereoscopicVideo=function(){t.arVideo instanceof ARProgrezz.Video.Panorama||(t.arVideo.width=window.innerWidth/2,t.arVideoStereo=document.createElement("video"),t.arVideoStereo.setAttribute("style","position: absolute; left: 50%; top: 0px; z-index: -1"),t.arVideoStereo.width=window.innerWidth/2,t.arVideoStereo.height=window.innerHeight,t.arVideoStereo.autoplay=!0,document.body.appendChild(t.arVideoStereo),t.arVideoStereo.src=window.URL.createObjectURL(ARProgrezz.Support.videoStream))},this.initVideo=function(i,n,r){o={flag:ARProgrezz.Utils.Flags.WAIT},ARProgrezz.Support.video&&ARProgrezz.Support.gyroscope?(e(),r&&t.activateStereoscopicVideo(),ARProgrezz.Utils.waitCallback(o,t.onSuccess)):(t.arVideo=new ARProgrezz.Video.Panorama(i,n),t.onSuccess&&t.onSuccess())}},ARProgrezz.Video.Panorama=function(e,t){function o(){var e=new THREE.SphereGeometry(d,r,a);e.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1));var t=THREE.ImageUtils.loadTexture(ARProgrezz.Utils.rootDirectory()+"/img/textures/equirectangular_city.jpg");t.minFilter=THREE.LinearFilter;var o=new THREE.MeshBasicMaterial({map:t});n=new THREE.Mesh(e,o),c.add(n)}var i=this;this.width=window.innerWidth,this.height=window.innerHeight,this.videoWidth=window.innerWidth,this.videoHeight=window.innerHeight;var n,r=45,a=30,c=e,d=t;this.updateSize=function(){i.videoWidth=i.width=window.innerWidth,i.videoHeight=i.height=window.innerHeight},this.destroy=function(){c.remove(n)},o()},ARProgrezz.Preloader=function(){var e=!1,t=null;this.initLoad=function(){e||(e=!0,t=document.createElement("div"),t.setAttribute("style","background: #FFF url('"+ARProgrezz.Utils.rootDirectory()+"/img/preloader.gif') no-repeat center center; opacity: 1; position: fixed; z-index: 999; top: 0px; left: 0px; overflow: visible; width: 100%; height: 100%; "),document.body.appendChild(t))},this.endLoad=function(){e&&(e=!1,document.body.removeChild(t))}},ARProgrezz.Object={},ARProgrezz.Object.Basic=function(e,t,o,i,n,r){function a(){alert(" > Objeto obtenido <\n > Coordenadas:\n   - Latitud: "+s.latitude+"\n   - Longitud: "+s.longitude)}function c(){w=i,e?(s.latitude=e.latitude,s.longitude=e.longitude):console.log("Error: Coordenadas de objeto no válidas"),t&&(s.collectable=t),o&&(s.onSelect=o),r&&(u=r*l)}function d(){c();var e=THREE.ImageUtils.loadTexture(ARProgrezz.Utils.rootDirectory()+f);e.anisotropy=n;var t=new THREE.MeshBasicMaterial({map:e}),o=new THREE.OctahedronGeometry(u,0);s.threeObject=new THREE.Mesh(o,t),s.threeObject.ARObject=s,s.updatePosition()}var s=this,l=.03,u=1.5,g=.4,h=.15,p=3,v=250,m=16777215,z=16711680,f="/img/textures/sold_to_spring.jpg";this.threeObject,this.latitude=0,this.longitude=0,this.collectable=!0,this.onSelect=a;var w,R=!1;this.select=function(){s.threeObject.material.color.setHex(z)},this.unselect=function(){R&&s.collectable||(R=!0,setTimeout(function(){s.threeObject.material.color.setHex(m)},v),s.onSelect())},this.updateAnimation=function(e){if(s.collectable&&R){var t=(h+(1-Math.pow(s.threeObject.scale.x,p)))*e;s.threeObject.scale.x-t>0?s.threeObject.scale.addScalar(-t):s.threeObject.visible=!1}s.threeObject.rotation.y+=g*e},this.updatePosition=function(){s.threeObject.position.z=w.getObjectZ(s.latitude),s.threeObject.position.x=w.getObjectX(s.longitude)},d()},ARProgrezz.PositionControls=function(e){function t(e){R=!0,b=e.targetTouches[0].clientX,S=e.targetTouches[0].clientY,A=y,P=C}function o(e){R&&(y=(b-e.targetTouches[0].clientX)*w+A,C=(e.targetTouches[0].clientY-S)*w+P)}function i(){R=!1}function n(e){e.preventDefault(),E=!0,b=e.clientX,S=e.clientY,A=y,P=C}function r(e){e.preventDefault(),E&&(y=(b-e.clientX)*f+A,C=(e.clientY-S)*f+P)}function a(e){e.preventDefault(),E=!1}function c(e,t){var o=6371,i=(t-e).toRad();e=e.toRad(),t=t.toRad();var n=Math.pow(Math.sin(i/2),2),r=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),a=o*r*1e3;return a}function d(e,t){var o=6371,i=(t-e).toRad(),n=Math.pow(Math.sin(i/2),2),r=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),a=o*r*1e3;return a}function s(){ARProgrezz.Support.gyroscope?(H(),window.addEventListener("orientationchange",H,!1),window.addEventListener("deviceorientation",x,!1)):(g=new THREE.Vector3(0,0,0),R=!1,E=!1,b=S=0,A=P=0,y=C=0,V=T=0,document.addEventListener("touchstart",t,!1),document.addEventListener("touchmove",o,!1),document.addEventListener("touchend",i,!1),document.addEventListener("mousedown",n,!1),document.addEventListener("mousemove",r,!1),document.addEventListener("mouseup",a,!1))}function l(){ARProgrezz.Support.geoCallback=function(e){p||(p=!0,U=e.coords.latitude,L=e.coords.longitude,h&&(h=!1,v.flag=ARProgrezz.Utils.Flags.SUCCESS),p=!1)}}var u=this;this.camera=e,this.camera.rotation.reorder("YXZ"),this.giroscopeEnabled=!1,this.onInit=null;var g,h,p,v,m={},z=0,f=.1,w=.15,R=!1,E=!1,b=0,S=0,A=0,P=0,y=0,C=0,V=0,T=0,U=0,L=0,x=function(e){m.alpha=e.alpha,m.beta=e.beta,m.gamma=e.gamma},H=function(){z=window.orientation||0};this.update=function(){if(u.giroscopeEnabled)if(ARProgrezz.Support.gyroscope){var e=m.alpha?THREE.Math.degToRad(m.alpha.toFixed(5)):0,t=m.beta?THREE.Math.degToRad(m.beta.toFixed(5)):0,o=m.gamma?THREE.Math.degToRad(m.gamma.toFixed(5)):0,i=z?THREE.Math.degToRad(z):0;k(u.camera.quaternion,e,t,o,i)}else C=Math.max(-89,Math.min(89,C)),V=THREE.Math.degToRad(90-C),T=THREE.Math.degToRad(y),g.x=Math.sin(V)*Math.cos(T),g.y=Math.cos(V),g.z=Math.sin(V)*Math.sin(T),u.camera.lookAt(g)};var k=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,o=new THREE.Quaternion,i=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(n,r,a,c,d){t.set(a,r,-c,"YXZ"),n.setFromEuler(t),n.multiply(i),n.multiply(o.setFromAxisAngle(e,-d))}}();this.getObjectZ=function(e){return c(U,e)*(e>U?-1:1)},this.getObjectX=function(e){return d(L,e)*(e>L?1:-1)},this.activate=function(){h=!0,p=!1,v={flag:ARProgrezz.Utils.Flags.WAIT},s(),l(),u.giroscopeEnabled=!0,ARProgrezz.Utils.waitCallback(v,function(){u.onInit&&u.onInit()})},this.activateGyroscope=function(){s(),u.giroscopeEnabled=!0},this.disarmGyroscope=function(){ARProgrezz.Support.gyroscope?(window.removeEventListener("orientationchange",H,!1),window.removeEventListener("deviceorientation",x,!1)):(document.removeEventListener("touchstart",t,!1),document.removeEventListener("touchmove",o,!1),document.removeEventListener("touchend",i,!1),document.removeEventListener("mousedown",n,!1),document.removeEventListener("mousemove",r,!1),document.removeEventListener("mouseup",a,!1)),u.giroscopeEnabled=!1}},ARProgrezz.Support={},function(e){function t(t,o){if(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia){var i={flag:ARProgrezz.Utils.Flags.WAIT};navigator.getUserMedia(t,function(t){e.video=g.video=!0,e.videoStream=t,i.flag=ARProgrezz.Utils.Flags.SUCCESS},function(){g.video=e.video=!1,i.flag=ARProgrezz.Utils.Flags.SUCCESS}),ARProgrezz.Utils.waitCallback(i,o)}else g.video=e.video=!1,o()}function o(e){var o=navigator.userAgent.toLowerCase();-1!=o.indexOf("chrome")?MediaStreamTrack.getSources(function(o){var i=null;for(s in o)"video"===o[s].kind&&"user"!=o[s].facing&&(i=o[s].id);t({video:{optional:[{sourceId:i}]},audio:!1},e)}):-1!=o.indexOf("firefox")?t({video:!0,audio:!1},e):t({video:!0,audio:!1},e)}function i(t){if(window.DeviceOrientationEvent){var o={flag:ARProgrezz.Utils.Flags.WAIT},i=1e3,n=0,r=function(){n+=1},a=function(){window.removeEventListener("deviceorientation",r,!1),g.gyroscope=e.gyroscope=n>1?!0:!1,o.flag=ARProgrezz.Utils.Flags.SUCCESS};window.addEventListener("deviceorientation",r,!1),ARProgrezz.Utils.waitCallback(o,t),setTimeout(a,i)}else g.gyroscope=e.gyroscope=!1,t()}function n(t){if(navigator.geolocation){var o={flag:ARProgrezz.Utils.Flags.WAIT};e.geoCallback=function(){null===e.geolocation&&(e.geolocation=g.geolocation=!0,o.flag=ARProgrezz.Utils.Flags.SUCCESS)},navigator.geolocation.watchPosition(function(t){e.geoCallback(t)}),setTimeout(function(){o.flag==ARProgrezz.Utils.Flags.WAIT&&(g.geolocation=e.geolocation=!1,o.flag=ARProgrezz.Utils.Flags.SUCCESS)},d),ARProgrezz.Utils.waitCallback(o,t)}else g.geolocation=e.geolocation=!1,t()}function r(){return e.gyroscope?g.video?void(e.onChangeVideo&&e.onChangeVideo()):void alert(">> Vídeo no disponible <<"):void alert(">> No se puede activar el vídeo con el giroscopio desactivado <<")}function a(){alert(">> No se puede utilizar el visor sin geolocalización <<")}function c(){return g.gyroscope?(e.video&&r(),void(e.onChangeGyroscope&&e.onChangeGyroscope())):void alert(">> Giroscopio no disponible <<")}var d=8e3,l="#55FC18",u="#666666";e.video=null,e.gyroscope=null,e.geolocation=null,e.onChangeVideo=null,e.onChangeGyroscope=null,e.onChangeGeolocation=null,e.videoStream=null,e.geoCallback=null;var g={video:!1,gyroscope:!1,geolocation:!1};e.check=function(t){n(function(){return g.geolocation?void i(function(){return g.gyroscope?void o(function(){t&&t()}):(g.video=e.video=!1,void(t&&t()))}):void alert(">> El visor no ha podido iniciarse por no ser capaz de acceder a la geolocalización <<")})},e.webglAvailable=function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}},e.Signals=function(){var e,t=this,o="/img/icons/",i=".png",n="-white",d={geolocation:null,gyroscope:null,video:null};this.changeSignalType=function(e){d[e].style.backgroundColor=ARProgrezz.Support[e]?l:u},this.init=function(){e=document.createElement("div"),e.setAttribute("style","position: absolute;z-index: 1;bottom: 10px;left: 10px;");for(var t=0;3>t;t++){var s,g;switch(t){case 0:s="geolocation",g=a;break;case 1:s="gyroscope",g=c;break;case 2:s="video",g=r}d[s]=document.createElement("img"),d[s].setAttribute("style","border: outset 1px;margin: 2.5px;");var h=function(){var e=s;return function(){this.src=ARProgrezz.Utils.rootDirectory()+o+e+i}}(),p=function(){var e=s;return function(){this.src=ARProgrezz.Utils.rootDirectory()+o+e+n+i}}();d[s].src=ARProgrezz.Utils.rootDirectory()+o+s+i,d[s].addEventListener("mousedown",p),d[s].addEventListener("mouseup",h),d[s].addEventListener("mouseleave",h),d[s].addEventListener("touchstart",p),d[s].addEventListener("touchend",h),d[s].addEventListener("touchcancel",h),d[s].addEventListener("click",g),d[s].style.backgroundColor=ARProgrezz.Support[s]?l:u,e.appendChild(document.createElement("br")),e.appendChild(d[s])}document.body.appendChild(e)},t.init()}}(ARProgrezz.Support),ARProgrezz.Viewer=function(){function e(e){for(s in e)R.settings[s]=e[s]}function t(){R.settings.mode="stereoscopic",U=T,x.style.backgroundColor="#55FC18",S.activateStereoscopicVideo()}function i(){R.settings.mode="normal",U=y,x.style.backgroundColor="#666666",S.disarmStereoscopicVideo()}function n(){"normal"===R.settings.mode?t():"stereoscopic"===R.settings.mode&&i(),g()}function r(){var e=document.createElement("div");e.setAttribute("style","position: absolute;z-index: 1;bottom: 10px;right: 10px;"),x=document.createElement("img"),x.setAttribute("style","border: outset 1px;margin: 2.5px;");var t=function(){this.src=ARProgrezz.Utils.rootDirectory()+G},o=function(){this.src=ARProgrezz.Utils.rootDirectory()+D};x.src=ARProgrezz.Utils.rootDirectory()+G,x.addEventListener("mousedown",o),x.addEventListener("mouseup",t),x.addEventListener("mouseleave",t),x.addEventListener("touchstart",o),x.addEventListener("touchend",t),x.addEventListener("touchcancel",t),x.addEventListener("click",n),e.appendChild(x),document.body.appendChild(e),"normal"===R.settings.mode?x.style.backgroundColor="#666666":"stereoscopic"===R.settings.mode&&(x.style.backgroundColor="#55FC18")}function a(e){return E=R.settings.range,P=new THREE.PerspectiveCamera(F,window.innerWidth/window.innerHeight,I,E+W),V=new ARProgrezz.PositionControls(P),V.onInit=e,V.activate(),{vision:P,controls:V}}function c(){var e={alpha:!0};return y=ARProgrezz.Support.webglAvailable()?new THREE.WebGLRenderer(e):new THREE.CanvasRenderer(e),y.setClearColor(0,0),y.setPixelRatio(window.devicePixelRatio),y.autoClear=!1,document.body.appendChild(y.domElement),T=new THREE.StereoEffect(y),T.eyeSeparation=j,"normal"===R.settings.mode?y:"stereoscopic"===R.settings.mode?T:(alert("Error: No se reconoce el modo seleccionado ("+R.settings.mode+")"),R.settings.mode="normal",y)}function d(e){var t={flag:ARProgrezz.Utils.Flags.WAIT};A=new THREE.Scene,U=c(),C=a(function(){t.flag=ARProgrezz.Utils.Flags.SUCCESS}),ARProgrezz.Utils.waitCallback(t,function(){e()})}function l(){for(o in H.children)H.children[o].ARObject.updateAnimation(b),H.children[o].ARObject.updatePosition()}function u(){function e(){requestAnimationFrame(e),b=q.getDelta(),l(),V.update(),"normal"===R.settings.mode&&y.clear(),U.render(A,P)}e()}function g(){setTimeout(function(){S.updateSize(),X=S.arVideo.height;var e=Math.min(S.arVideo.width/S.arVideo.videoWidth,S.arVideo.height/S.arVideo.videoHeight);R.viewerWidth="normal"!==R.settings.mode&&ARProgrezz.Support.video?window.innerWidth:e*S.arVideo.videoWidth,R.viewerHeight=e*S.arVideo.videoHeight,P.aspect=R.viewerWidth/R.viewerHeight,P.updateProjectionMatrix(),y.domElement.setAttribute("style","display: block; margin: auto; padding-top: "+Math.trunc((X-R.viewerHeight)/2)+"px;"),y.setPixelRatio(window.devicePixelRatio),U.setSize(R.viewerWidth,R.viewerHeight)},O)}function h(){H=new THREE.Object3D,A.add(H),k=new THREE.Vector2,M=new THREE.Raycaster,window.addEventListener("mousedown",p,!1),window.addEventListener("mouseup",m,!1),window.addEventListener("touchstart",v,!1),window.addEventListener("touchend",m,!1)}function p(e){z(e.clientX,e.clientY),N&&N.select()}function v(e){z(e.targetTouches[0].clientX,e.targetTouches[0].clientY),N&&N.select()}function m(){N&&(N.unselect(),N=null)}function z(e,t){"normal"===R.settings.mode?(k.x=2*(e/R.viewerWidth)-1,k.y=1-2*(t/R.viewerHeight)):"stereoscopic"===R.settings.mode&&(k.x=0,k.y=0),M.setFromCamera(k,P);var o=M.intersectObjects(H.children);o.length>0&&(N=o[0].object.ARObject)}function f(){S.removeVideo(),ARProgrezz.Support.video=!ARProgrezz.Support.video,S=new ARProgrezz.Video,S.onSuccess=function(){L.changeSignalType("video"),g()},S.initVideo(A,R.settings.range,"stereoscopic"===R.settings.mode)}function w(){V.disarmGyroscope(),ARProgrezz.Support.gyroscope=!ARProgrezz.Support.gyroscope,L.changeSignalType("gyroscope"),V.activateGyroscope()}var R=this;this.settings={mode:"normal",range:50},this.inited=!1,this.onInit=null,this.viewerWidth=0,this.viewerHeight=0;var E,b,S,A,P,y,C,V,T,U,L,x,H,k,M,O=300,F=60,j=5,W=50,I=.1,G="/img/icons/stereo.png",D="/img/icons/stereo-white.png",q=new THREE.Clock,X=0,N=null;this.initViewer=function(t){document.addEventListener("click",ARProgrezz.Utils.fullScreen,!1),ARProgrezz.Utils.lockOrientation();var o=new ARProgrezz.Preloader;o.initLoad(),t&&e(t);var i={flag:ARProgrezz.Utils.Flags.WAIT};ARProgrezz.Support.check(function(){i.flag=ARProgrezz.Utils.Flags.SUCCESS}),ARProgrezz.Utils.waitCallback(i,function(){ARProgrezz.Support.onChangeVideo=f,ARProgrezz.Support.onChangeGyroscope=w,L=new ARProgrezz.Support.Signals,d(function(){S=new ARProgrezz.Video,S.onSuccess=function(){r(),g(),window.addEventListener("orientationchange",g,!1),window.addEventListener("resize",g,!1),h(),u(),inited=!0,R.onInit&&R.onInit(),o.endLoad()},S.initVideo(A,R.settings.range,"stereoscopic"===R.settings.mode)})})},this.addObject=function(e){var t;switch(e.type){case"basic":t=new ARProgrezz.Object.Basic(e.coords,e.collectable,e.onSelect,V,y.getMaxAnisotropy(),R.settings.range);break;default:return void console.log("Error: Tipo de objeto '"+e.type+"' desconocido")}H.add(t.threeObject)}};