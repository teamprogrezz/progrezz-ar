ARProgrezz={},ARProgrezz.Utils={},function(e){e.Flags={SUCCESS:1,ERROR:-1,WAIT:0};var t=200;e.waitCallback=function(o,i){i&&(o.flag==ARProgrezz.Utils.Flags.WAIT?setTimeout(e.waitCallback,t,o,i):o.flag==ARProgrezz.Utils.Flags.SUCCESS&&i())},e.debugText=function(e){var t=document.querySelector("p");t?t.removeChild(t.childNodes[0]):(t=document.createElement("p"),document.body.appendChild(t));var o=document.createTextNode(e);t.appendChild(o)},e.rootDirectory=function(){for(var e=document.getElementsByTagName("script"),t=null,o=0;o<e.length;o++)if(""!=e[o].src&&(t=e[o].src),-1!=e[o].src.search("ARProgrezz.js")){t=e[o].src;break}var i=t.split("/").pop();return t.replace("/js/"+i,"")},e.fullScreen=function(){var e=document.documentElement,t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullScreen;t&&t.call(e)},e.lockOrientation=function(){screen.lockOrientation=screen.lockOrientation||screen.webkitLockOrientation||screen.mozLockOrientation||screen.msLockOrientation,screen.lockOrientation?(screen.lockOrientation("landscape"),alert("Orientación bloqueada")):alert("No se puede bloquear la orientación")}}(ARProgrezz.Utils),ARProgrezz.Preloader=function(){var e=!1,t=null;this.initLoad=function(){e||(e=!0,t=document.createElement("div"),t.setAttribute("style","background: #FFF url('"+ARProgrezz.Utils.rootDirectory()+"/img/preloader.gif') no-repeat center center; opacity: 1; position: fixed; z-index: 999; top: 0px; left: 0px; overflow: visible; width: 100%; height: 100%; "),document.body.appendChild(t))},this.endLoad=function(){e&&(e=!1,document.body.removeChild(t))}},ARProgrezz.Support={},function(e){function t(t){if(e.accessVideo=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,e.accessVideo){var o={flag:ARProgrezz.Utils.Flags.WAIT};navigator.getUserMedia=e.accessVideo,navigator.getUserMedia({video:!0,audio:!1},function(t){e.video=r.video=!0,e.videoStream=t,o.flag=ARProgrezz.Utils.Flags.SUCCESS},function(){r.video=e.video=!1,o.flag=ARProgrezz.Utils.Flags.SUCCESS}),ARProgrezz.Utils.waitCallback(o,t)}else r.video=e.video=!1,t()}function o(t){if(window.DeviceOrientationEvent){var o={flag:ARProgrezz.Utils.Flags.WAIT},i=1e3,n=0,a=function(){n+=1},c=function(){window.removeEventListener("deviceorientation",a,!1),r.gyroscope=e.gyroscope=n>1?!0:!1,o.flag=ARProgrezz.Utils.Flags.SUCCESS};window.addEventListener("deviceorientation",a,!1),ARProgrezz.Utils.waitCallback(o,t),setTimeout(c,i)}else r.gyroscope=e.gyroscope=!1,t()}function i(t){if(navigator.geolocation){var o={flag:ARProgrezz.Utils.Flags.WAIT};navigator.geolocation.getCurrentPosition(function(){e.geolocation=r.geolocation=!0,o.flag=ARProgrezz.Utils.Flags.SUCCESS},function(){r.geolocation=e.geolocation=!1,o.flag=ARProgrezz.Utils.Flags.SUCCESS}),setTimeout(function(){o.flag==ARProgrezz.Utils.Flags.WAIT&&(r.geolocation=e.geolocation=!1,o.flag=ARProgrezz.Utils.Flags.SUCCESS)},n),ARProgrezz.Utils.waitCallback(o,t)}else r.geolocation=e.geolocation=!1,t()}var n=8e3;e.video=null,e.gyroscope=null,e.geolocation=null,e.accessVideo=null,e.videoStream=null;var r={video:!1,gyroscope:!1,geolocation:!1};e.check=function(e){t(function(){o(function(){i(function(){e&&e()})})})},e.webglAvailable=function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}},e.activateVideo=function(){console.log("Pinguino")},e.activateGeolocation=function(){alert("No se puede desactivar la geolocalización")},e.activateGyroscope=function(){console.log("Pinguino")},e.Signals=function(){var e=this;this.init=function(){var e=document.createElement("div");e.setAttribute("style","position: absolute;z-index: 1;bottom: 10px;left: 10px;");for(var t=0;3>t;t++){var o=document.createElement("img"),i=document.createElement("a");e.appendChild(document.createElement("br")),o.setAttribute("style","border: outset 1px;margin: 2.5px;");var n;switch(t){case 0:n=ARProgrezz.Support.geolocation,o.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/geolocation.png",o.onmousedown=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/geolocation-white.png"},o.onmouseup=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/geolocation.png"},o.onmouseleave=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/geolocation.png"},o.ontouchstart=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/geolocation-white.png"},o.ontouchend=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/geolocation.png"},o.ontouchcancel=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/geolocation.png"},i.onclick=ARProgrezz.Support.activateGeolocation;break;case 1:n=ARProgrezz.Support.gyroscope,o.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/gyroscope.png",o.onmousedown=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/gyroscope-white.png"},o.onmouseup=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/gyroscope.png"},o.onmouseleave=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/gyroscope.png"},o.ontouchstart=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/gyroscope-white.png"},o.ontouchend=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/gyroscope.png"},o.ontouchcancel=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/gyroscope.png"},i.setAttribute("onclick","ARProgrezz.Support.activateGyroscope();");break;case 2:n=ARProgrezz.Support.video,o.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/videocamera.png",o.onmousedown=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/videocamera-white.png"},o.onmouseup=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/videocamera.png"},o.onmouseleave=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/videocamera.png"},o.ontouchstart=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/videocamera-white.png"},o.ontouchend=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/videocamera.png"},o.ontouchcancel=function(){this.src=ARProgrezz.Utils.rootDirectory()+"/img/icons/videocamera.png"},i.setAttribute("onclick","ARProgrezz.Support.activateVideo();")}o.style.backgroundColor=n?"#55FC18":"#666666",i.appendChild(o),e.appendChild(i)}document.body.appendChild(e)},e.init()}}(ARProgrezz.Support),ARProgrezz.Viewer=function(e){function t(e){for(s in e)this.settings[s]=e[s]}function i(t){return"normal"===z.settings.mode?(f=new THREE.PerspectiveCamera(U,window.innerWidth/window.innerHeight,y,T),A=new ARProgrezz.PositionControls(f),A.onInit=t,A.activate(),{vision:f,controls:A}):void("stereoscopic"===e.mode||alert("Error: No se reconoce el modo seleccionado ("+ar.settings.mode+")"))}function n(e){var t={flag:ARProgrezz.Utils.Flags.WAIT};m=new THREE.Scene,w=i(function(){t.flag=ARProgrezz.Utils.Flags.SUCCESS});var o={alpha:!0};R=ARProgrezz.Support.webglAvailable()?new THREE.WebGLRenderer(o):new THREE.CanvasRenderer(o),R.setClearColor(0,0),R.setPixelRatio(window.devicePixelRatio),document.body.appendChild(R.domElement),ARProgrezz.Utils.waitCallback(t,function(){e()})}function r(){for(o in E.children)E.children[o].ARObject.update(v)}function a(){function e(){requestAnimationFrame(e),v=C.getDelta(),r(),A.update(),R.render(m,f)}e()}function c(){setTimeout(function(){p.updateSize(),H=p.arVideo.height;var e=Math.min(p.arVideo.width/p.arVideo.videoWidth,p.arVideo.height/p.arVideo.videoHeight);z.viewerWidth=e*p.arVideo.videoWidth,z.viewerHeight=e*p.arVideo.videoHeight,f.aspect=z.viewerWidth/z.viewerHeight,f.updateProjectionMatrix(),R.domElement.setAttribute("style","display: block; margin: auto; padding-top: "+Math.trunc((H-z.viewerHeight)/2)+"px;"),R.setSize(z.viewerWidth,z.viewerHeight),R.setPixelRatio(window.devicePixelRatio)},S)}function l(){E=new THREE.Object3D,m.add(E),P=new THREE.Vector2,b=new THREE.Raycaster,window.addEventListener("mousedown",d,!1),window.addEventListener("mouseup",g,!1),window.addEventListener("touchstart",u,!1),window.addEventListener("touchend",g,!1)}function d(e){h(e.clientX,e.clientY),O&&O.select()}function u(e){h(e.targetTouches[0].clientX,e.targetTouches[0].clientY),O&&O.select()}function g(){O&&(O.unselect(),O=null)}function h(e,t){P.x=2*(e/z.viewerWidth)-1,P.y=1-2*(t/z.viewerHeight),b.setFromCamera(P,f);var o=b.intersectObjects(E.children);o.length>0&&(O=o[0].object.ARObject)}var z=this;this.settings={mode:"normal"},this.inited=!1,this.onInit=null,this.viewerWidth=0,this.viewerHeight=0;var v,p,m,f,R,w,A,E,P,b,S=300,U=60,y=.1,T=3e3,C=new THREE.Clock,H=0,O=null;this.initViewer=function(e){document.addEventListener("click",ARProgrezz.Utils.fullScreen,!1),ARProgrezz.Utils.lockOrientation();var o=new ARProgrezz.Preloader;o.initLoad(),e&&t(e);var i={flag:ARProgrezz.Utils.Flags.WAIT};ARProgrezz.Support.check(function(){i.flag=ARProgrezz.Utils.Flags.SUCCESS}),ARProgrezz.Utils.waitCallback(i,function(){new ARProgrezz.Support.Signals;n(function(){p=new ARProgrezz.Video,p.onSuccess=function(){c(),window.addEventListener("orientationchange",c,!1),window.addEventListener("resize",c,!1),l(),a(),inited=!0,z.onInit&&z.onInit(),o.endLoad()},p.initVideo(m)})})},this.addObject=function(e){var t;switch(e.type){case"basic":t=new ARProgrezz.Object.Basic(e.coords,e.collectable,e.onSelect,A);break;default:return void console.log("Error: Tipo de objeto '"+e.type+"' desconocido")}E.add(t.threeObject)}},ARProgrezz.PositionControls=function(e){function t(e){e.preventDefault(),A=!0,P=e.targetTouches[0].clientX,b=e.targetTouches[0].clientY,S=y,U=T}function o(e){e.preventDefault(),A&&(y=(P-e.targetTouches[0].clientX)*w+S,T=(e.targetTouches[0].clientY-b)*w+U)}function i(e){e.preventDefault(),A=!1}function n(e){e.preventDefault(),E=!0,P=e.clientX,b=e.clientY,S=y,U=T}function r(e){e.preventDefault(),E&&(y=(P-e.clientX)*R+S,T=(e.clientY-b)*R+U)}function a(e){e.preventDefault(),E=!1}function c(e,t){var o=6371,i=(t-e).toRad();e=e.toRad(),t=t.toRad();var n=Math.pow(Math.sin(i/2),2),r=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),a=o*r*1e3;return a}function s(e,t){var o=6371,i=(t-e).toRad(),n=Math.pow(Math.sin(i/2),2),r=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),a=o*r*1e3;return a}function l(){e.position.setX(M>O?c(O,M):-c(O,M)),e.position.setZ(V>x?s(x,V):-s(x,V))}function d(){ARProgrezz.Support.gyroscope?(F(),window.addEventListener("orientationchange",F,!1),window.addEventListener("deviceorientation",k,!1)):(h=new THREE.Vector3(0,0,0),A=!1,E=!1,P=b=0,S=U=0,y=T=0,C=H=0,document.addEventListener("touchstart",t,!1),document.addEventListener("touchmove",o,!1),document.addEventListener("touchend",i,!1),document.addEventListener("mousedown",n,!1),document.addEventListener("mousemove",r,!1),document.addEventListener("mouseup",a,!1))}function u(){function e(){}navigator.geolocation.watchPosition(function(e){v||(v=!0,z?(console.log("Aquí estoy"),O=M=e.coords.latitude,x=V=e.coords.longitude,z=!1,p.flag=ARProgrezz.Utils.Flags.SUCCESS):(M=e.coords.latitude,V=e.coords.longitude),l(),v=!1)},function(){alert("No se ha podido T.T")}),setInterval(e,5e3)}var g=this;this.camera=e,this.camera.rotation.reorder("YXZ"),this.enabled=!0,this.onInit=null;var h,z,v,p,m={},f=0,R=.1,w=.15,A=!1,E=!1,P=0,b=0,S=0,U=0,y=0,T=0,C=0,H=0,O=0,x=0,M=0,V=0,k=function(e){m.alpha=e.alpha,m.beta=e.beta,m.gamma=e.gamma},F=function(){f=window.orientation||0};this.update=function(){if(g.enabled)if(ARProgrezz.Support.gyroscope){var e=m.alpha?THREE.Math.degToRad(m.alpha.toFixed(5)):0,t=m.beta?THREE.Math.degToRad(m.beta.toFixed(5)):0,o=m.gamma?THREE.Math.degToRad(m.gamma.toFixed(5)):0,i=f?THREE.Math.degToRad(f):0;j(g.camera.quaternion,e,t,o,i)}else T=Math.max(-85,Math.min(85,T)),C=THREE.Math.degToRad(90-T),H=THREE.Math.degToRad(y),h.x=3e3*Math.sin(C)*Math.cos(H),h.y=3e3*Math.cos(C),h.z=3e3*Math.sin(C)*Math.sin(H),g.camera.lookAt(h)};var j=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,o=new THREE.Quaternion,i=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(n,r,a,c,s){t.set(a,r,-c,"YXZ"),n.setFromEuler(t),n.multiply(i),n.multiply(o.setFromAxisAngle(e,-s))}}();this.getObjectZ=function(e){return c(O,e)*(e>O?-1:1)},this.getObjectX=function(e){return s(x,e)*(e>x?1:-1)},this.activate=function(){z=!0,v=!1,p={flag:ARProgrezz.Utils.Flags.WAIT},d(),u(),g.enabled=!0,ARProgrezz.Utils.waitCallback(p,function(){g.onInit&&g.onInit()})},this.disarmGyroscope=function(){ARProgrezz.Support.gyroscope?(window.removeEventListener("orientationchange",F,!1),window.removeEventListener("deviceorientation",k,!1)):(document.removeEventListener("touchstart",t,!1),document.removeEventListener("touchmove",o,!1),document.removeEventListener("touchend",i,!1),document.removeEventListener("mousedown",n,!1),document.removeEventListener("mousemove",r,!1),document.removeEventListener("mouseup",a,!1))},this.disarmGeolocation=function(){},this.disarm=function(){g.enabled=!1}},ARProgrezz.Video=function(){function e(e){navigator.getUserMedia=ARProgrezz.Support.accessVideo,navigator.getUserMedia(e,function(e){o.arVideo=document.createElement("video"),o.arVideo.setAttribute("style","position: absolute; left: 0px; top: 0px; z-index: -1"),o.arVideo.width=window.innerWidth,o.arVideo.height=window.innerHeight,o.arVideo.autoplay=!0,o.arVideo.onloadedmetadata=function(){i.flag=ARProgrezz.Utils.Flags.SUCCESS},document.body.appendChild(o.arVideo),o.arVideo.src=window.URL.createObjectURL(e)},function(e){alert("Error: "+e),i.flag=ARProgrezz.Utils.Flags.ERROR})}function t(){var t=navigator.userAgent.toLowerCase();-1!=t.indexOf("chrome")?MediaStreamTrack.getSources(function(t){var o=null;for(s in t)"video"===t[s].kind&&"user"!=t[s].facing&&(alert(JSON.stringify(t[s])),o=t[s].id);e({video:{optional:[{sourceId:o}]},audio:!1})}):-1!=t.indexOf("firefox")?e({video:!0,audio:!1}):(alert(t),e({video:!0,audio:!1}))}var o=this;this.arVideo=null,this.onSuccess=null;var i=null;this.updateSize=function(){o.arVideo instanceof ARProgrezz.Video.Panorama?o.arVideo.updateSize():(o.arVideo.width=window.innerWidth,o.arVideo.height=window.innerHeight)},this.initVideo=function(e){i={flag:ARProgrezz.Utils.Flags.WAIT},ARProgrezz.Support.video&&ARProgrezz.Support.gyroscope?(t(),ARProgrezz.Utils.waitCallback(i,o.onSuccess)):(o.arVideo=new ARProgrezz.Video.Panorama(e),o.onSuccess&&o.onSuccess())}},ARProgrezz.Video.Panorama=function(e){function t(){var e=new THREE.SphereGeometry(i,n,r);e.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1));var t=THREE.ImageUtils.loadTexture(ARProgrezz.Utils.rootDirectory()+"/img/textures/equirectangular_city.jpg");t.minFilter=THREE.LinearFilter;var o=new THREE.MeshBasicMaterial({map:t}),c=new THREE.Mesh(e,o);a.add(c)}var o=this;this.width=window.innerWidth,this.height=window.innerHeight,this.videoWidth=window.innerWidth,this.videoHeight=window.innerHeight;var i=1e3,n=45,r=30,a=e;this.updateSize=function(){o.videoWidth=o.width=window.innerWidth,o.videoHeight=o.height=window.innerHeight},t()},ARProgrezz.Object={},ARProgrezz.Object.Basic=function(e,t,o,i){function n(){console.log("Objeto capturado :D")}function r(){v=i,e?(c.latitude=e.latitude,c.longitude=e.longitude):console.log("Error: Coordenadas de objeto no válidas"),t&&(c.collectable=t),o&&(c.onSelect=o)}function a(){r();var e=THREE.ImageUtils.loadTexture(ARProgrezz.Utils.rootDirectory()+"/img/textures/sold_to_spring.jpg"),t=new THREE.MeshBasicMaterial({map:e}),o=new THREE.OctahedronGeometry(s,0);c.threeObject=new THREE.Mesh(o,t),c.threeObject.ARObject=c,c.threeObject.position.x=v.getObjectX(c.longitude),c.threeObject.position.z=v.getObjectZ(c.latitude),console.log(c.threeObject.position.x,c.threeObject.position.z)}var c=this,s=3,l=.4,d=.15,u=3,g=250,h=16777215,z=16711680;this.threeObject,this.latitude=0,this.longitude=0,this.collectable=!0,this.onSelect=n;var v,p=!1;this.select=function(){p&&c.collectable||c.threeObject.material.color.setHex(z)},this.unselect=function(){p=!0,setTimeout(function(){c.threeObject.material.color.setHex(h)},g),c.onSelect()},this.update=function(e){c.collectable&&p&&(c.threeObject.scale.x>0?c.threeObject.scale.addScalar(-(d+(1-Math.pow(c.threeObject.scale.x,u)))*e):c.threeObject.visible=!1),c.threeObject.rotation.y+=l*e},a()};